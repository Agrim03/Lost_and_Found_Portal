<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Items</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="view-container">
    <div class="view-reports-title">
      <p style="font-size: 50px; font-weight: bolder; font-family: 'League Spartan', sans-serif; color: #b51d1d; margin-top: 30px; margin-left: 5px;">Lost or Found Items</p>
    </div>

    <main class="view-item-box">
      <section class="filters">
        <h2 style="font-family: 'League Spartan', sans-serif; font-size: 30px; text-align: center;">Filter Items</h2>

        <label for="filterType">Type:</label>
        <select id="filterType">
          <option value="lost">Lost</option>
          <option value="found">Found</option>
        </select>

        <label for="filterLine">Line:</label>
        <select id="filterLine">
          <option value="">All Lines</option>
        </select>

        <label for="filterStation">Station:</label>
        <select id="filterStation">
          <option value="">All Stations</option>
        </select>

        <label for="filterDate">Date:</label>
        <input type="date" id="filterDate" />

        <button onclick="fetchItems()">Apply Filter</button>
      </section>

      <section id="itemsContainer" class="items-list"></section>
    </main>
  </div>

  <script>
    const stationsByLine = {
      red: ["Rithala", "Kashmere Gate"],
      green: ["Inderlok", "Kirti Nagar"],
      pink: ["Lajpat Nagar", "Mayur Vihar"],
      blue: ["Dwarka", "Rajiv Chowk", "Noida Sector 18"],
      yellow: ["New Delhi", "HUDA City Centre"],
    };

    function populateFilterDropdowns() {
      const lineSelect = document.getElementById("filterLine");
      const stationSelect = document.getElementById("filterStation");

      lineSelect.innerHTML = `<option value="">All Lines</option>`;
      stationSelect.innerHTML = `<option value="">All Stations</option>`;

      Object.keys(stationsByLine).forEach(line => {
        const option = document.createElement("option");
        option.value = line;
        option.textContent = line.charAt(0).toUpperCase() + line.slice(1) + " Line";
        lineSelect.appendChild(option);
      });

      lineSelect.addEventListener("change", () => {
        const selectedLine = lineSelect.value;
        stationSelect.innerHTML = `<option value="">All Stations</option>`;
        (stationsByLine[selectedLine] || []).forEach(station => {
          const opt = document.createElement("option");
          opt.value = station;
          opt.textContent = station;
          stationSelect.appendChild(opt);
        });
      });
    }

    async function fetchItems() {
      const type = document.getElementById("filterType").value;
      const line = document.getElementById("filterLine").value;
      const station = document.getElementById("filterStation").value;
      const date = document.getElementById("filterDate").value;

      let url = `/api/${type}?`;
      if (line) url += `line=${encodeURIComponent(line)}&`;
      if (station) url += `station=${encodeURIComponent(station)}&`;
      if (date) url += `date=${encodeURIComponent(date)}&`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        renderItems(data, type);
      } catch (err) {
        console.error("Error fetching:", err);
        document.getElementById("itemsContainer").innerHTML = `<p style="color:red;">Error fetching items.</p>`;
      }
    }

    function renderItems(items, type) {
  const container = document.getElementById("itemsContainer");
  container.innerHTML = "";

  if (!items.length) {
    container.innerHTML = "<p>No items found.</p>";
    return;
  }

  const typeLabel = type.charAt(0).toUpperCase() + type.slice(1); // Lost / Found

  items.forEach(item => {
    const rawDate = item.found_date || item.date_found || item.lost_date || item.date_lost || null;

    let displayDate = "N/A";
    if (rawDate) {
      const parsed = new Date(rawDate);
      displayDate = isNaN(parsed.getTime()) ? "N/A" : parsed.toLocaleDateString();
    }

    const html = `
      <div class="item-card">
        <h3>${item.item_name}</h3>
        <p><strong>Type:</strong> ${typeLabel}</p>
        <p><strong>Date:</strong> ${displayDate}</p>
        <p><strong>Line:</strong> ${item.line}</p>
        <p><strong>Station:</strong> ${item.station}</p>
        <p><strong>Remarks:</strong> ${item.remarks || "None"}</p>
        ${item.image ? `<img src="/uploads/${item.image}" alt="Item Image" style="max-width: 200px;">` : ""}
        <p><strong>Reported By:</strong> ${item.user_name || "N/A"} (${item.user_email || "N/A"})</p>
      </div>
    `;
    container.innerHTML += html;
  });
}

    window.onload = () => {
      populateFilterDropdowns();
      const params = new URLSearchParams(window.location.search);
      const type = params.get("type");
      if (type) document.getElementById("filterType").value = type;
      fetchItems();
    };
  </script>
</body>
</html>
